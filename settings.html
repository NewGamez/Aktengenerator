<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>NCPD ‚Äì Einstellungen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- üîí Zugriffsschutz -->
  <script>
    try {
      if (sessionStorage.getItem("ncpd_admin_logged_in") !== "true") {
        window.location.replace("index.html");
      }
    } catch (e) {
      window.location.replace("index.html");
    }
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    * { box-sizing:border-box; margin:0; padding:0; font-family:"Inter", system-ui, sans-serif; }

    body {
      min-height:100vh;
      background: radial-gradient(circle at top, #252542 0, #050511 55%, #050509 100%);
      color:#fff;
      padding: 20px;
    }

    .topbar{
      max-width: 1400px;
      margin: 0 auto 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 14px 18px;
      background: rgba(5, 6, 20, 0.92);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 14px;
      backdrop-filter: blur(10px);
    }

    .title-main { font-size:1rem; font-weight:600; }
    .title-sub  { font-size:0.8rem; opacity:0.7; }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding: 8px 14px;
      border-radius: 10px;
      border:none;
      background:#5865f2;
      color:#fff;
      font-size:0.82rem;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
      transition: transform 0.06s ease, background 0.12s ease;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }

    .btn-secondary{
      background:#1e213b;
      border:1px solid rgba(255,255,255,0.08);
    }

    .btn-danger{
      background:#3b1e27;
      border:1px solid rgba(255,255,255,0.08);
    }

    .wrap{
      max-width: 1400px;
      margin: 0 auto;
    }

    .panel{
      background: rgba(10, 12, 25, 0.8);
      padding: 16px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.05);
      box-shadow: 0 10px 25px rgba(0,0,0,0.4);
    }

    input, select{
      background:#0f1122;
      border:1px solid #2c2e40;
      color:#fff;
      padding: 8px 9px;
      border-radius: 8px;
      font-size:0.8rem;
      width:100%;
      outline:none;
    }

    table{
      width:100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td{
      padding: 8px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      font-size:0.78rem;
      text-align:left;
      vertical-align: middle;
    }

    th{ opacity:0.8; }

    .actions{
      display:flex;
      gap:6px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    .toolbar{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:center;
    }

    .search-row{
      display:flex;
      gap:10px;
      margin: 12px 0;
      align-items:center;
    }

    .hint{
      opacity:0.7;
      font-size:0.78rem;
      margin-top: 10px;
    }

    @media (max-width: 900px){
      .actions{ justify-content:flex-start; }
    }
  </style>
</head>
<body>

  <div class="topbar">
    <div>
      <div class="title-main">NCPD Einstellungen</div>
      <div class="title-sub">Mitarbeiterverwaltung ‚Ä¢ Suche ‚Ä¢ Uprank/Derank</div>
    </div>
    <div class="toolbar">
      <button class="btn btn-secondary" onclick="window.location.href='generator.html'">Zum Generator</button>
      <button class="btn btn-secondary" id="btnLogout">Logout</button>
    </div>
  </div>

  <div class="wrap">
    <div class="panel">

      <div class="toolbar" style="margin-bottom:10px;">
        <button class="btn btn-secondary" id="btnReset" type="button">Auf Default zur√ºck</button>
        <button class="btn" id="btnAdd" type="button">+ Mitarbeiter hinzuf√ºgen</button>
        <button class="btn" id="btnSave" type="button">Speichern</button>
      </div>

      <!-- üîç Suche -->
      <div class="search-row">
        <input id="searchInput" type="text" placeholder="Suche nach Name oder Dienstnummer (z.B. PD-48)">
        <button class="btn btn-secondary" id="btnClearSearch" type="button">X</button>
      </div>

      <table>
        <thead>
          <tr>
            <th style="min-width:220px;">Name</th>
            <th style="min-width:220px;">Rang</th>
            <th style="min-width:160px;">Dienstnummer</th>
            <th style="min-width:200px;">Discord-ID</th>
            <th style="text-align:right; min-width:320px;">Aktionen</th>
          </tr>
        </thead>
        <tbody id="empTbody"></tbody>
      </table>

      <div class="hint">
        Tipp: Suche filtert live nach Name oder Dienstnummer. Nach √Ñnderungen bitte ‚ÄûSpeichern‚Äú klicken.
      </div>

    </div>
  </div>

<script>
const STORAGE_KEY = "ncpd_officerMap_v1";

const RANKS = [
  "President of Police",
  "Chief of Police",
  "Assistant Chief of Police",
  "Deputy Chief",
  "Bureau Chief",
  "Commander",
  "Watch Commander",
  "Captain",
  "Inspector",
  "Deputy Inspector",
  "Master Lieutenant",
  "Lieutenant III",
  "Lieutenant II",
  "Lieutenant I",
  "Staff Sergeant",
  "Sergeant III",
  "Sergeant II",
  "Sergeant I",
  "Specialist",
  "Anw√§rter"
];
  
const DEFAULT_OFFICER_MAP = {
  // ---------- TEAM RED ----------
  "361115973203525633": { name: "Lukas Lutz", dienstnummer: "PD-01", rang: "Chief of Police" },
  "929489098471796756": { name: "Alev Sunal", dienstnummer: "PD-02", rang: "Assistant Chief of Police" },
  "689193377261944853": { name: "Pau Sunal", dienstnummer: "PD-03", rang: "Deputy Chief" },
  "749676361274359869": { name: "Peter Klumb", dienstnummer: "PD-04", rang: "Deputy Chief" },
  "281504730067369985": { name: "Steve McGarret", dienstnummer: "PD-05", rang: "Bureau Chief" },

  // ---------- TEAM BLUE ----------
  "721476043814207830": { name: "Tayo Backa", dienstnummer: "PD-09", rang: "Watch Commander" },
  "663782248998502447": { name: "Walter Waldmeister", dienstnummer: "PD-16", rang: "Inspector" },
  "340137585240440833": { name: "Morata Soler", dienstnummer: "PD-17", rang: "Inspector" },
  "366609124038934528": { name: "Ben Morisson", dienstnummer: "PD-11", rang: "Captain" },
  "708062101457076228": { name: "Vito Ramirez", dienstnummer: "PD-19", rang: "Deputy Inspector" },
  "750431732607483905": { name: "Jule Waldmeister", dienstnummer: "PD-18", rang: "Deputy Inspector" },

  // ---------- TEAM GOLD ----------
  "1142017198718730271": { name: "Blaze Redman", dienstnummer: "PD-22", rang: "Master Lieutenant" },
  "228380461628391424": { name: "Zane Blackwood", dienstnummer: "PD-23", rang: "Master Lieutenant" },
  "378598475971166208": { name: "Toni Deluca", dienstnummer: "PD-26", rang: "Lieutenant III" },
  "1134903991818534942": { name: "Daniel Waldmeister", dienstnummer: "PD-25", rang: "Lieutenant III" },
  "723312724519551006": { name: "Andreas Hackl", dienstnummer: "PD-34", rang: "Lieutenant I" },
  "1217116992616661033": { name: "Panther Nova", dienstnummer: "PD-35", rang: "Lieutenant I" },

  // ---------- TEAM SILVER ----------
  "697119782834536520": { name: "Anton Horvath", dienstnummer: "PD-48", rang: "Staff Sergeant" },
  "247006489632440322": { name: "Felix Miller", dienstnummer: "PD-40", rang: "Specialist" },
  "587348686326202369": { name: "Andreas Graham", dienstnummer: "PD-41", rang: "Staff Sergeant" },
  "1008577835503452211": { name: "Luke Dijk", dienstnummer: "PD-42", rang: "Sergeant I" },
  "498101850856226839": { name: "Reiner Hirsch", dienstnummer: "PD-43", rang: "Staff Sergeant" },
  "543002544348200960": { name: "Jackson Dayne", dienstnummer: "PD-44", rang: "Specialist" },
  "717473357909590099": { name: "Max Koslowski", dienstnummer: "PD-45", rang: "Specialist" },
  "693183499657543780": { name: "Ottmar Zittlau", dienstnummer: "PD-46", rang: "Sergeant III" },
  "513456111160918027": { name: "Ian Miller", dienstnummer: "PD-47", rang: "Sergeant III" },
  "886307752706719825": { name: "Max Lockheed", dienstnummer: "PD-49", rang: "Specialist" },
  "764520163633922060": { name: "Alejandro Rodriguez", dienstnummer: "PD-50", rang: "Specialist" },
  "564390978547351553": { name: "Antonio Moretti", dienstnummer: "PD-51", rang: "Specialist" },
  "550392010612146207": { name: "Keystone Brown", dienstnummer: "PD-53", rang: "Specialist" },
  "711866485651275787": { name: "David Baum", dienstnummer: "PD-54", rang: "Sergeant I" },
  "450016531229966336": { name: "Jason Shaw", dienstnummer: "PD-56", rang: "Sergeant I" },
  "541633624051679262": { name: "Harald Hernandez", dienstnummer: "PD-57", rang: "Staff Sergeant" },
  "1093573634213285989": { name: "Lucius Lich", dienstnummer: "PD-58", rang: "Staff Sergeant" },
  "931064598570893343": { name: "Joey Reed", dienstnummer: "PD-59", rang: "Staff Sergeant" },
  "808712195390701618": { name: "Ali Coban", dienstnummer: "PD-61", rang: "Staff Sergeant" },
  "1261019609818075207": { name: "Elina Thompson", dienstnummer: "PD-62", rang: "Sergeant II" },
  "437314188059344898": { name: "Enrique Vegas", dienstnummer: "PD-63", rang: "Sergeant I" },
  "788866575305408544": { name: "Alvaro Reinh", dienstnummer: "PD-64", rang: "Sergeant III" },
  "878966028347015198": { name: "Peter Maier", dienstnummer: "PD-66", rang: "Specialist" },
  "1283519810570944543": { name: "Sultan Can", dienstnummer: "PD-67", rang: "Staff Sergeant" },
  "811317056245989397": { name: "Dario Ramirez", dienstnummer: "PD-68", rang: "Specialist" },
  "1315048772408971415": { name: "Diego Santos", dienstnummer: "PD-70", rang: "Staff Sergeant" },
  "808103110316785725": { name: "Nosa Holy", dienstnummer: "PD-71", rang: "Sergeant III" },
  "481793329328291840": { name: "Lamar Kasim", dienstnummer: "PD-72", rang: "Sergeant I" },
  "1357827587950252153": { name: "Efe Voga", dienstnummer: "PD-73", rang: "Sergeant I" },
  "579359902800281611": { name: "Beton Tapi", dienstnummer: "PD-74", rang: "Sergeant I" },
  "831635399679017002": { name: "Tom Black", dienstnummer: "PD-77", rang: "Sergeant II" },
  "966081394310783006": { name: "Michael Korczak", dienstnummer: "PD-78", rang: "Specialist" },
  "1215412476359737366": { name: "Lukas Rothe", dienstnummer: "PD-52", rang: "Specialist" },
  "677541121383202817": { name: "Ben Stein", dienstnummer: "PD-55", rang: "Specialist" },

  // ---------- TEAM GREEN ----------
  "877241505016844328": { name: "Salva Sol", dienstnummer: "PA-52", rang: "Anw√§rter" },
  "624039199028543499": { name: "Ludovico Greco", dienstnummer: "PA-56", rang: "Anw√§rter" },
  "935269358098321418": { name: "Nico Bublich", dienstnummer: "PA-57", rang: "Anw√§rter" },
  "1069361772324200478": { name: "Roman Schlag", dienstnummer: "PA-62", rang: "Anw√§rter" },
  "161210739174932481": { name: "Eduardo Sanchez", dienstnummer: "PA-66", rang: "Anw√§rter" },
  "730909080649990204": { name: "Max Aklubat", dienstnummer: "PA-69", rang: "Anw√§rter" },
  "966711299419537468": { name: "Lukas Denzel", dienstnummer: "PA-71", rang: "Anw√§rter" },
  "925887471198306374": { name: "Noah Schlotter", dienstnummer: "PA-73", rang: "Anw√§rter" },
  "526132485101191203": { name: "Max Brechtelsbauer", dienstnummer: "PA-76", rang: "Anw√§rter" },
  "508377615241969674": { name: "Abusa Hanco", dienstnummer: "PA-78", rang: "Anw√§rter" },
  "530031383007985665": { name: "Michael Johnson", dienstnummer: "PA-79", rang: "Anw√§rter" }
};

let officerMap = loadOfficerMap();
let searchQuery = "";

function deepClone(obj){ return JSON.parse(JSON.stringify(obj)); }

function loadOfficerMap(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return deepClone(DEFAULT_OFFICER_MAP);
    const parsed = JSON.parse(raw);
    if(!parsed || typeof parsed !== "object") return deepClone(DEFAULT_OFFICER_MAP);
    return parsed;
  } catch(e) {
    return deepClone(DEFAULT_OFFICER_MAP);
  }
}

function saveOfficerMap(){
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(officerMap));
    alert("Gespeichert!");
  } catch(e) {
    alert("Speichern fehlgeschlagen (localStorage).");
  }
}

function rankIndex(r){
  const i = RANKS.indexOf(r);
  return i === -1 ? (RANKS.length - 1) : i;
}

function uprank(id){
  const o = officerMap[id];
  if(!o) return;
  const i = rankIndex(o.rang);
  if(i <= 0) return;
  o.rang = RANKS[i - 1];
  render();
}

function derank(id){
  const o = officerMap[id];
  if(!o) return;
  const i = rankIndex(o.rang);
  if(i >= RANKS.length - 1) return;
  o.rang = RANKS[i + 1];
  render();
}

function kuendigen(id){
  if(!officerMap[id]) return;
  if(confirm("Mitarbeiter wirklich entfernen?")){
    delete officerMap[id];
    render();
  }
}

/* ‚úÖ Mitarbeiter hinzuf√ºgen (funktioniert wieder) */
function addMitarbeiter(){
  const id = prompt("Discord-ID (nur Zahlen, eindeutig):");
  if(!id) return;

  const cleanId = id.trim();
  if(!/^\d{10,30}$/.test(cleanId)){
    alert("Ung√ºltige Discord-ID. Bitte nur Zahlen verwenden.");
    return;
  }
  if(officerMap[cleanId]){
    alert("Diese Discord-ID existiert schon.");
    return;
  }

  const name = (prompt("Name (Vorname Nachname):") || "").trim() || "Unbekannt";
  const dn = (prompt("Dienstnummer (z.B. PD-80 / PA-80):") || "").trim();
  const rang = "Anw√§rter";

  officerMap[cleanId] = { name, dienstnummer: dn, rang };
  render();
}

function render(){
  const tbody = document.getElementById("empTbody");
  tbody.innerHTML = "";

  let entries = Object.entries(officerMap).map(([id,o]) => ({ id, ...o }));

  // sort: nach Rang (hoch->niedrig), dann Name
  entries.sort((a,b) => {
    const ra = rankIndex(a.rang);
    const rb = rankIndex(b.rang);
    if(ra !== rb) return ra - rb;
    return (a.name || "").localeCompare((b.name || ""), "de");
  });

  // Filter
  if(searchQuery){
    entries = entries.filter(e =>
      (e.name || "").toLowerCase().includes(searchQuery) ||
      (e.dienstnummer || "").toLowerCase().includes(searchQuery)
    );
  }

  entries.forEach(e => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td><input value="${escapeHtml(e.name || "")}"></td>
      <td>
        <select>${RANKS.map(r => `<option ${r === e.rang ? "selected" : ""}>${escapeHtml(r)}</option>`).join("")}</select>
      </td>
      <td><input value="${escapeHtml(e.dienstnummer || "")}"></td>
      <td>${escapeHtml(e.id)}</td>
      <td>
        <div class="actions">
          <button class="btn btn-secondary" type="button">Uprank</button>
          <button class="btn btn-secondary" type="button">Derank</button>
          <button class="btn btn-danger" type="button">K√ºndigen</button>
        </div>
      </td>
    `;

    const nameInput = tr.querySelectorAll("input")[0];
    const dnInput   = tr.querySelectorAll("input")[1];
    const rangSel   = tr.querySelector("select");

    const upBtn   = tr.querySelectorAll("button")[0];
    const downBtn = tr.querySelectorAll("button")[1];
    const fireBtn = tr.querySelectorAll("button")[2];

    nameInput.addEventListener("input", () => { officerMap[e.id].name = nameInput.value; });
    dnInput.addEventListener("input",   () => { officerMap[e.id].dienstnummer = dnInput.value; });
    rangSel.addEventListener("change",  () => { officerMap[e.id].rang = rangSel.value; });

    upBtn.addEventListener("click",   () => uprank(e.id));
    downBtn.addEventListener("click", () => derank(e.id));
    fireBtn.addEventListener("click", () => kuendigen(e.id));

    tbody.appendChild(tr);
  });
}

/* kleine HTML-Escape helper */
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* üîç Suche */
document.getElementById("searchInput").addEventListener("input", e => {
  searchQuery = (e.target.value || "").toLowerCase().trim();
  render();
});

document.getElementById("btnClearSearch").addEventListener("click", () => {
  searchQuery = "";
  document.getElementById("searchInput").value = "";
  render();
});

/* Buttons */
document.getElementById("btnAdd").addEventListener("click", addMitarbeiter);
document.getElementById("btnSave").addEventListener("click", saveOfficerMap);

document.getElementById("btnReset").addEventListener("click", () => {
  if(confirm("Auf Default zur√ºcksetzen? (Gespeicherte Liste wird gel√∂scht)")){
    localStorage.removeItem(STORAGE_KEY);
    officerMap = loadOfficerMap();
    render();
  }
});

document.getElementById("btnLogout").addEventListener("click", () => {
  sessionStorage.removeItem("ncpd_admin_logged_in");
  window.location.href = "index.html";
});

render();
</script>

</body>
</html>
