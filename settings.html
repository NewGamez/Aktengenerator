<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>NCPD â€“ Einstellungen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- ðŸ”’ Zugriffsschutz -->
  <script>
    try {
      if (sessionStorage.getItem("ncpd_admin_logged_in") !== "true") {
        window.location.replace("index.html");
      }
    } catch (e) {
      window.location.replace("index.html");
    }
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    * { box-sizing:border-box; margin:0; padding:0; font-family:"Inter", system-ui, sans-serif; }

    body {
      min-height:100vh;
      background: radial-gradient(circle at top, #252542 0, #050511 55%, #050509 100%);
      color:#fff;
      padding:20px;
    }

    .topbar{
      max-width:1400px;
      margin:0 auto 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:14px 18px;
      background:rgba(5,6,20,0.92);
      border:1px solid rgba(255,255,255,0.05);
      border-radius:14px;
    }

    .btn{
      padding:8px 14px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      font-size:0.82rem;
      background:#5865f2;
      color:#fff;
    }

    .btn-secondary{ background:#1e213b; }
    .btn-danger{ background:#3b1e27; }

    .panel{
      max-width:1400px;
      margin:0 auto;
      background:rgba(10,12,25,0.8);
      padding:16px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.05);
    }

    input, select{
      width:100%;
      padding:8px;
      background:#0f1122;
      border:1px solid #2c2e40;
      color:#fff;
      border-radius:8px;
      font-size:0.8rem;
    }

    table{ width:100%; border-collapse:collapse; margin-top:10px; }
    th, td{
      padding:8px;
      border-bottom:1px solid rgba(255,255,255,0.06);
      font-size:0.78rem;
    }

    .actions{ display:flex; gap:6px; justify-content:flex-end; }
    .toolbar{ display:flex; gap:8px; justify-content:flex-end; margin-bottom:10px; }
    .search-row{ display:flex; gap:10px; margin-bottom:10px; }

    .team-row td{
      font-weight:600;
      background:rgba(255,255,255,0.04);
      opacity:0.9;
    }
  </style>
</head>
<body>

<div class="topbar">
  <div>
    <strong>NCPD Einstellungen</strong><br>
    <span style="opacity:.7;font-size:.8rem;">Mitarbeiterverwaltung</span>
  </div>
  <div>
    <button class="btn btn-secondary" onclick="location.href='generator.html'">Zum Generator</button>
    <button class="btn btn-secondary" id="btnLogout">Logout</button>
  </div>
</div>

<div class="panel">

  <div class="toolbar">
    <button class="btn btn-secondary" id="btnReset">Reset</button>
    <button class="btn" id="btnAdd">+ Mitarbeiter</button>
    <button class="btn" id="btnSave">Speichern</button>
  </div>

  <div class="search-row">
    <input id="searchInput" placeholder="Suche nach Name oder Dienstnummer">
    <button class="btn btn-secondary" id="btnClearSearch">X</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Rang</th>
        <th>Dienstnummer</th>
        <th>Discord-ID</th>
        <th style="text-align:right;">Aktionen</th>
      </tr>
    </thead>
    <tbody id="empTbody"></tbody>
  </table>

</div>

<script>
const STORAGE_KEY = "ncpd_officerMap_v1";

const RANKS = [
  "President of Police",
  "Chief of Police","Assistant Chief of Police","Deputy Chief","Bureau Chief",
  "Commander","Watch Commander","Captain","Inspector","Deputy Inspector",
  "Master Lieutenant","Lieutenant III","Lieutenant II","Lieutenant I",
  "Staff Sergeant","Sergeant III","Sergeant II","Sergeant I","Specialist",
  "AnwÃ¤rter"
];

let officerMap = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
let searchQuery = "";

function getTeamInfo(dn){
  if(!dn) return {key:"unknown", label:"Unbekannt"};
  dn = dn.toUpperCase();
  if(dn.startsWith("PA-")) return {key:"green", label:"Team Green"};
  const n = parseInt(dn.split("-")[1],10);
  if(n<=5) return {key:"red",label:"Team Red"};
  if(n<=19) return {key:"blue",label:"Team Blue"};
  if(n<=39) return {key:"gold",label:"Team Gold"};
  return {key:"silver",label:"Team Silver"};
}

function numVal(dn){
  const m = dn?.match(/-(\d+)/);
  return m ? parseInt(m[1],10) : 9999;
}

function render(){
  const tbody = document.getElementById("empTbody");
  tbody.innerHTML = "";

  let entries = Object.entries(officerMap).map(([id,o])=>({...o,id,team:getTeamInfo(o.dienstnummer)}));

  if(searchQuery){
    entries = entries.filter(e =>
      e.name.toLowerCase().includes(searchQuery) ||
      e.dienstnummer.toLowerCase().includes(searchQuery)
    );
  }

  const ORDER = ["red","blue","gold","silver","green","unknown"];
  entries.sort((a,b)=>{
    const t = ORDER.indexOf(a.team.key)-ORDER.indexOf(b.team.key);
    if(t!==0) return t;
    return numVal(a.dienstnummer)-numVal(b.dienstnummer);
  });

  let lastTeam=null;

  entries.forEach(e=>{
    if(e.team.key!==lastTeam){
      const tr=document.createElement("tr");
      tr.className="team-row";
      tr.innerHTML=`<td colspan="5">${e.team.label}</td>`;
      tbody.appendChild(tr);
      lastTeam=e.team.key;
    }

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><input value="${e.name}"></td>
      <td><select>${RANKS.map(r=>`<option ${r===e.rang?"selected":""}>${r}</option>`).join("")}</select></td>
      <td><input value="${e.dienstnummer}"></td>
      <td>${e.id}</td>
      <td class="actions">
        <button class="btn btn-secondary">â†‘</button>
        <button class="btn btn-secondary">â†“</button>
        <button class="btn btn-danger">âœ–</button>
      </td>
    `;

    const [nameI,dnI]=tr.querySelectorAll("input");
    const sel=tr.querySelector("select");
    const [up,down,del]=tr.querySelectorAll("button");

    nameI.oninput=()=>officerMap[e.id].name=nameI.value;
    dnI.oninput=()=>officerMap[e.id].dienstnummer=dnI.value;
    sel.onchange=()=>officerMap[e.id].rang=sel.value;

    up.onclick=()=>{ const i=RANKS.indexOf(e.rang); if(i>0){officerMap[e.id].rang=RANKS[i-1];render();}};
    down.onclick=()=>{ const i=RANKS.indexOf(e.rang); if(i<RANKS.length-1){officerMap[e.id].rang=RANKS[i+1];render();}};
    del.onclick=()=>{ if(confirm("Entfernen?")){delete officerMap[e.id];render();}};

    tbody.appendChild(tr);
  });
}

document.getElementById("btnAdd").onclick=()=>{
  const id=prompt("Discord-ID:");
  if(!id||officerMap[id]) return;
  officerMap[id]={name:"Neuer Mitarbeiter",dienstnummer:"PD-",rang:"AnwÃ¤rter"};
  render();
};

document.getElementById("btnSave").onclick=()=>{
  localStorage.setItem(STORAGE_KEY,JSON.stringify(officerMap));
  alert("Gespeichert");
};

document.getElementById("btnReset").onclick=()=>{
  if(confirm("Alles lÃ¶schen?")){
    officerMap={};
    localStorage.removeItem(STORAGE_KEY);
    render();
  }
};

document.getElementById("btnLogout").onclick=()=>{
  sessionStorage.removeItem("ncpd_admin_logged_in");
  location.href="index.html";
};

document.getElementById("searchInput").oninput=e=>{
  searchQuery=e.target.value.toLowerCase();
  render();
};
document.getElementById("btnClearSearch").onclick=()=>{
  searchQuery="";
  searchInput.value="";
  render();
};

render();
</script>

</body>
</html>
