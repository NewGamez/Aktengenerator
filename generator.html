<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>NCPD Aktengenerator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="ncpd-logo.png">

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: "Inter", system-ui, sans-serif; }

    body {
      min-height: 100vh;
      background: radial-gradient(circle at top, #252542 0, #050511 55%, #050509 100%);
      color: #fff;
      display: flex;
      flex-direction: column;
    }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      background: rgba(5, 6, 20, 0.92);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .topbar-left { display: flex; align-items: center; gap: 10px; }

    .hero-logo {
      width: 36px; height: 36px; object-fit: cover; border-radius: 50%;
      display: block; margin-right: 8px; opacity: 0.95;
    }

    .topbar-title-main { font-size: 1rem; font-weight: 600; }
    .topbar-title-sub { font-size: 0.8rem; opacity: 0.7; }

    .logout-btn {
      font-size: 0.8rem;
      text-decoration: none;
      color: #d5d7ff;
      padding: 6px 14px;
      border-radius: 30px;
      border: 1px solid rgba(213, 215, 255, 0.25);
      background: rgba(20, 22, 40, 0.8);
      transition: 0.2s;
    }
    .logout-btn:hover { background: rgba(35, 38, 70, 0.95); }

    .login-status { text-align: right; font-size: 0.78rem; line-height: 1.25; }
    .login-status-main { font-weight: 500; }
    .login-status-sub { opacity: 0.8; }
    .login-status-officer { opacity: 0.8; margin-top: 2px; font-size: 0.76rem; }

    .page {
      flex: 1;
      width: 100%;
      max-width: 1700px;
      margin: 20px auto;
      padding: 0 20px 30px;
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.4fr);
      gap: 18px;
    }
    @media (max-width: 1100px) { .page { grid-template-columns: 1fr; } }

    .panel {
      background: rgba(10, 12, 25, 0.8);
      padding: 18px 18px 20px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.05);
      box-shadow: 0 10px 25px rgba(0,0,0,0.4);
    }

    .panel-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 12px; }
    .panel-title { font-size: 0.95rem; font-weight: 600; }
    .panel-subtitle { font-size: 0.75rem; opacity: 0.7; }

    label { display: block; margin: 8px 0 3px; font-size: 0.8rem; opacity: 0.9; }

    input, textarea, select {
      width: 100%;
      background: #0f1122;
      border: 1px solid #2c2e40;
      color: #fff;
      padding: 8px 9px;
      border-radius: 7px;
      font-size: 0.82rem;
      outline: none;
      transition: border 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }
    input:focus, textarea:focus, select:focus {
      border-color: #5865f2;
      box-shadow: 0 0 0 1px rgba(88, 101, 242, 0.45);
      background: #10132a;
    }

    textarea { min-height: 110px; resize: vertical; }

    .row { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; }
    @media (max-width: 700px) { .row { grid-template-columns: 1fr; } }

    .checkbox-row {
      display: flex; flex-wrap: wrap;
      gap: 8px 12px;
      margin: 4px 0 8px;
      font-size: 0.78rem;
    }
    .checkbox-row label { margin: 0; display: inline-flex; align-items: center; gap: 5px; }
    .checkbox-row input[type="checkbox"] { width: 14px; height: 14px; border-radius: 4px; cursor: pointer; padding: 0; }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border-radius: 8px;
      padding: 9px 14px;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      margin-top: 12px;
      background: #5865f2;
      color: #fff;
      box-shadow: 0 8px 20px rgba(88,101,242,0.45);
      transition: transform 0.06s ease, box-shadow 0.06s ease, background 0.15s ease;
    }
    .btn:hover { background: #6a74ff; transform: translateY(-1px); box-shadow: 0 11px 26px rgba(88,101,242,0.55); }
    .btn:active { transform: translateY(0); box-shadow: 0 7px 16px rgba(88,101,242,0.5); }

    .btn-secondary {
      background: #1e213b;
      box-shadow: none;
      border: 1px solid rgba(255,255,255,0.08);
      margin-left: 6px;
    }
    .btn-secondary:hover { background: #272b4b; box-shadow: 0 8px 20px rgba(0,0,0,0.4); }

    .tab-buttons {
      display: inline-flex;
      flex-wrap: wrap;
      gap: 6px;
      background: #080a19;
      padding: 3px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.06);
      margin-bottom: 14px;
    }

    .tab-btn {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      font-size: 0.78rem;
      cursor: pointer;
      background: transparent;
      color: #a4a7d7;
      transition: 0.15s;
    }
    .tab-btn.active {
      background: #5865f2;
      color: #fff;
      box-shadow: 0 6px 15px rgba(88,101,242,0.5);
    }
    .tab-btn:not(.active):hover { background: rgba(255,255,255,0.04); }

    .hidden { display: none; }

    #output {
      width: 100%;
      min-height: 380px;
      background: #050614;
      border-radius: 10px;
      border: 1px solid #282a3e;
      padding: 10px 12px;
      color: #f9f9ff;
      font-family: "Consolas", "Fira Code", monospace;
      font-size: 0.8rem;
      white-space: pre-wrap;
      resize: vertical;
    }

    #tab-verzeichnis h3 { margin-top: 12px; margin-bottom: 6px; font-size: 0.9rem; font-weight: 600; }
    .verz-hinweis { font-size: 0.78rem; opacity: 0.7; margin-bottom: 10px; }
    .verz-list { margin-bottom: 6px; }
    .verz-item {
      padding: 7px 9px;
      background: #0f1122;
      border: 1px solid #262943;
      border-radius: 7px;
      margin-bottom: 4px;
      cursor: pointer;
      font-size: 0.78rem;
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }
    .verz-item:hover { background: #171a33; }
    .verz-item-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 230px; }
    .verz-item-date { opacity: 0.6; font-size: 0.74rem; }
    .verz-empty { font-size: 0.78rem; opacity: 0.65; padding: 6px 2px 10px; }

    .label-required::after{
      content:" *";
      color:#ff4d4f;
      font-weight:700;
      margin-left:2px;
    }

    .field-error{
      border-color:#ff4d4f !important;
      box-shadow: 0 0 0 1px rgba(255,77,79,0.55) !important;
      background: rgba(255,77,79,0.06) !important;
    }

    .group-error{
      outline: 1px solid rgba(255,77,79,0.65);
      border-radius: 9px;
      padding: 8px 10px;
      background: rgba(255,77,79,0.05);
    }

    .error-hint{
      margin-top: 6px;
      font-size: 0.76rem;
      color: #ffb3b6;
      opacity: 0.95;
      display:none;
    }
    .error-hint.show{ display:block; }

    .validation-banner{
      display:none;
      margin: 10px 0 14px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,77,79,0.35);
      background: rgba(255,77,79,0.08);
      color: #ffd3d5;
      font-size: 0.82rem;
    }
    .validation-banner.show{ display:block; }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbar-left">
      <img src="ncpd-logo.png" class="hero-logo" alt="NCPD Logo">
      <div>
        <div class="topbar-title-main">NCPD Aktengenerator</div>
        <div class="topbar-title-sub">Aktengenerator ‚Ä¢ NCPD II</div>
      </div>
    </div>

    <div style="display:flex; align-items:center; gap:10px;">
      <div class="login-status">
        <div id="login-main" class="login-status-main">Nicht mit Discord verbunden</div>
        <div id="login-sub" class="login-status-sub">Bitte √ºber das Login einloggen.</div>
        <div id="login-officer-info" class="login-status-officer"></div>
      </div>
      <a class="logout-btn" href="index.html">Logout</a>
    </div>
  </header>

  <main class="page">
    <section class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">NCPD II √úbersicht</div>
          <div class="panel-subtitle">Strafakte ‚Ä¢ Kollektivakte ‚Ä¢ Ergreifungsakte ‚Ä¢ Verzeichnis</div>
        </div>
      </div>

      <div class="tab-buttons">
        <button class="tab-btn active" data-tab="strafakte">Strafakte</button>
        <button class="tab-btn" data-tab="kollektivakte">Kollektivakte</button>
        <button class="tab-btn" data-tab="fahndung">Ergreifungsakte</button>
        <button class="tab-btn" data-tab="verzeichnis">Verzeichnis</button>
      </div>

      <!-- STRAFAKTE -->
      <div id="tab-strafakte">
        <div class="row">
          <div>
            <label for="st-officer">Officer</label>
            <input id="st-officer" type="text" />
          </div>
          <div>
            <label for="st-tatort">Tatort und Zeitraum</label>
            <input id="st-tatort" type="text" placeholder="ORT, bei PLZ XXXX | Am ... bis ..." />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="st-beschuldigte">Beschuldigte Person(en)</label>
            <textarea id="st-beschuldigte" placeholder="Vorname Nachname, Geb. TT.MM.JJJJ"></textarea>
          </div>
          <div>
            <label for="st-geschaedigte">Gesch√§digte Person(en)</label>
            <textarea id="st-geschaedigte" placeholder="Vorname Nachname, Geb. TT.MM.JJJJ"></textarea>
          </div>
        </div>

        <label for="st-sachverhalt">Sachverhalt aus Sicht der Beh√∂rde</label>
        <textarea id="st-sachverhalt" placeholder="Straftat pro Satz ..."></textarea>
        <div class="checkbox-row" style="margin-top:6px;">
          <label>
            <input type="checkbox" id="st-sachverhalt-include" />
            Sachverhalt in Akte √ºbernehmen (nur wenn keine Einigung)
          </label>
        </div>

        <label id="st-id-label">Identit√§tsfeststellung</label>
        <div id="st-id-group" class="checkbox-row">
          <label><input type="checkbox" id="st-id-pers" /> Personalausweis</label>
          <label><input type="checkbox" id="st-id-waffe" /> Waffenschein</label>
          <label><input type="checkbox" id="st-id-fs" /> F√ºhrerschein</label>
          <label><input type="checkbox" id="st-id-finger" /> Fingerabdruckscanner</label>
        </div>
        <div id="st-id-hint" class="error-hint">Bitte mindestens eine Option ausw√§hlen.</div>

        <label for="st-zeugen">Weitere beteiligte Einheiten/Zeugen</label>
        <textarea id="st-zeugen" placeholder="PD-XX&#10;PA-XX&#10;USM-XX ..."></textarea>

        <label for="st-gegenstaende">Abgenommene Gegenst√§nde</label>
        <textarea id="st-gegenstaende" placeholder="1x Smartphone"></textarea>

        <div class="row">
          <div>
            <label for="st-verlesen">Verlesen</label>
            <input id="st-verlesen" type="text" placeholder="z. B. FIB-XX" />
          </div>
          <div>
            <label for="st-beisein">Beisein</label>
            <input id="st-beisein" type="text" placeholder="z. B. SD-XX" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="st-rechtsbeistand">Rechtsbeistand</label>
            <select id="st-rechtsbeistand">
              <option value="">‚Äì bitte w√§hlen ‚Äì</option>
              <option value="bestand">bestand</option>
              <option value="verzichtete">verzichtete</option>
            </select>
          </div>
          <div>
            <label for="st-medizin">Medizinische Versorgung</label>
            <select id="st-medizin">
              <option value="">‚Äì bitte w√§hlen ‚Äì</option>
              <option value="bestand">bestand</option>
              <option value="verzichtete">verzichtete</option>
            </select>
          </div>
        </div>

        <div>
          <label for="st-gezeichnet">Gezeichnet von</label>
          <textarea id="st-gezeichnet" rows="2"></textarea>
        </div>

        <button class="btn" id="btn-strafakte">Strafakte generieren</button>
      </div>

      <!-- KOLLEKTIVAKTE -->
      <div id="tab-kollektivakte" class="hidden">
        <div class="row">
          <div>
            <label for="ko-officer">Officer</label>
            <input id="ko-officer" type="text" />
          </div>
          <div>
            <label for="ko-tatort">Tatort und Tatzeit</label>
            <input id="ko-tatort" type="text" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="ko-beschuldigte">Beschuldigte Personen</label>
            <textarea id="ko-beschuldigte"></textarea>
          </div>
          <div>
            <label for="ko-geschaedigte">Gesch√§digte Personen</label>
            <textarea id="ko-geschaedigte"></textarea>
          </div>
        </div>

        <label for="ko-sachverhalt">Sachverhalt aus Sicht des NCPDs</label>
        <textarea id="ko-sachverhalt"></textarea>

        <label id="ko-id-label">Identit√§tsfeststellung</label>
        <div id="ko-id-group" class="checkbox-row">
          <label><input type="checkbox" id="ko-id-pers" /> Personalausweis</label>
          <label><input type="checkbox" id="ko-id-waffe" /> Waffenschein</label>
          <label><input type="checkbox" id="ko-id-fs" /> F√ºhrerschein</label>
          <label><input type="checkbox" id="ko-id-finger" /> Fingerabdruckscanner</label>
        </div>
        <div id="ko-id-hint" class="error-hint">Bitte mindestens eine Option ausw√§hlen.</div>

        <label for="ko-zeugen">Weitere beteiligte Einheiten/Zeugen</label>
        <textarea id="ko-zeugen"></textarea>

        <label for="ko-gegenstaende">Abgenommene Gegenst√§nde</label>
        <textarea id="ko-gegenstaende"></textarea>
        <div style="font-size:0.76rem; opacity:0.7; margin-top:4px; margin-bottom:6px;">
          Hinweis: Bitte bei den Gegenst√§nden selbst eintragen, von wem diese abgenommen wurden.
        </div>

        <div class="row">
          <div>
            <label for="ko-verlesen">Verlesen</label>
            <input id="ko-verlesen" type="text" />
          </div>
          <div>
            <label>&nbsp;</label>
            <input type="text" disabled style="opacity:0; pointer-events:none;" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="ko-beisein">Beisein</label>
            <input id="ko-beisein" type="text" />
          </div>
          <div>
            <label for="ko-rechtsbeistand">Rechtsbeistand</label>
            <select id="ko-rechtsbeistand">
              <option value="">‚Äì bitte w√§hlen ‚Äì</option>
              <option value="bestand">bestand</option>
              <option value="verzichtete">verzichtete</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="ko-medizin">Medizinische Versorgung</label>
            <select id="ko-medizin">
              <option value="">‚Äì bitte w√§hlen ‚Äì</option>
              <option value="bestand">bestand</option>
              <option value="verzichtete">verzichtete</option>
            </select>
          </div>
          <div>
            <label for="ko-eilverfahren">Eilverfahren</label>
            <input id="ko-eilverfahren" type="text" placeholder="z. B. abgelehnt durch DOJ-XX" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="ko-bussgeld">Bu√ügelddatum</label>
            <input id="ko-bussgeld" type="text" placeholder="TT.MM.JJJJ" />
          </div>
          <div>
            <label>&nbsp;</label>
            <input type="text" disabled style="opacity:0; pointer-events:none;" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="ko-bestaetigt-von">Kollektivakte genehmigt von</label>
            <input id="ko-bestaetigt-von" type="text" />
          </div>
          <div>
            <label for="ko-bestaetigt-zeit">Genehmigt um (Uhrzeit)</label>
            <input id="ko-bestaetigt-zeit" type="text" placeholder="z. B. 23:45" />
          </div>
        </div>

        <div>
          <label for="ko-gezeichnet">Gezeichnet von</label>
          <textarea id="ko-gezeichnet" rows="2"></textarea>
          <button class="btn" id="btn-kollektivakte">Kollektivakte generieren</button>
        </div>
      </div>

      <!-- ERGREIFUNGSAKTE (IN BEARBEITUNG) -->
      <div id="tab-fahndung" class="hidden">
        <div style="
          margin-bottom: 12px;
          padding: 10px 12px;
          border-radius: 12px;
          border: 1px solid rgba(255,255,255,0.10);
          background: rgba(255,255,255,0.04);
          color: rgba(255,255,255,0.85);
          font-size: 0.82rem;
          line-height: 1.35;
        ">
          <strong style="color:#ffd3d5;">Hinweis:</strong>
          Die Ergreifungsakte ist aktuell <strong>in Bearbeitung</strong>. Diese Funktion ist derzeit deaktiviert.
        </div>

        <div style="opacity:0.45; pointer-events:none;">
          <div class="row">
            <div>
              <label for="fa-officer">Officer</label>
              <input id="fa-officer" type="text" />
            </div>
            <div>
              <label for="fa-datum">Datum / Uhrzeit</label>
              <input id="fa-datum" type="text" placeholder="z. B. 05.12.2025 14:30 Uhr" />
            </div>
          </div>

          <label for="fa-tatort">Tatort und Zeitraum</label>
          <input id="fa-tatort" type="text" placeholder="z. B. ... | 06.12.2025 16:00‚Äì16:15 Uhr" />

          <label for="fa-person">Gesuchte Person</label>
          <textarea id="fa-person" placeholder="Name, Geburtsdatum, Beschreibung"></textarea>

          <label for="fa-paragrafen">Straftatbest√§nde / Paragraphen</label>
          <textarea id="fa-paragrafen" placeholder="¬ß..."></textarea>

          <label for="fa-sachverhalt">Sachverhalt</label>
          <textarea id="fa-sachverhalt" placeholder="Freitextlicher Sachverhalt, Ermittlungsstand ..."></textarea>

          <label for="fa-hinweise">Besondere Hinweise</label>
          <textarea id="fa-hinweise" placeholder="Bewaffnung, Gef√§hrlichkeit, letzte Sichtung"></textarea>

          <label for="fa-einheiten">Beteiligte Einheiten</label>
          <textarea id="fa-einheiten" placeholder="PD-XX, FIB-XX, USM-XX ‚Ä¶"></textarea>

          <div>
            <label for="fa-gezeichnet">Gezeichnet von</label>
            <textarea id="fa-gezeichnet" rows="2"></textarea>
          </div>

          <button class="btn" id="btn-fahndung">Ergreifungsakte generieren</button>
        </div>
      </div>

      <div id="tab-verzeichnis" class="hidden">
        <p class="verz-hinweis">
          Hier werden alle Akten gespeichert, die mit deinem Discord-Account <br>
          auf diesem Ger√§t erstellt wurden. Klick auf einen Eintrag, um ihn rechts zu laden.
        </p>

        <h3>Strafakten</h3>
        <div id="verzeichnis-straf" class="verz-list"></div>

        <h3>Kollektivakten</h3>
        <div id="verzeichnis-kollektiv" class="verz-list"></div>

        <h3>Ergreifungsakten</h3>
        <div id="verzeichnis-fahndung" class="verz-list"></div>
      </div>
    </section>

    <section class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">Generierte Akte</div>
          <div class="panel-subtitle">Text kann direkt kopiert werden ‚Ä¢ Verzeichnis-Eintr√§ge laden die Akte hier</div>
        </div>
      </div>

      <div id="validation-banner" class="validation-banner">
        Bitte f√ºlle die rot markierten Pflichtfelder aus.
      </div>

      <textarea id="output" readonly></textarea>

      <div style="margin-top: 12px; display: flex; gap: 8px;">
        <button class="btn-secondary btn" id="btn-copy">Kopieren</button>
        <button class="btn-secondary btn" id="btn-reset">Zur√ºcksetzen</button>
      </div>

      <div id="kollektiv-hinweis"
           style="
             margin-top: 12px;
             text-align: center;
             font-size: 1.05rem;
             font-weight: 600;
             opacity: 0.9;
             white-space: nowrap;
             display: none;
           ">
        Abgenommene Gegenst√§nde m√ºssen selber im Aktentablet vermerkt werden.
      </div>
    </section>
  </main>

  <script>
    let currentDiscordId = null;
    const STORAGE_KEY = "ncpd_officerMap_v1";

    const defaultOfficerMap = {
      "361115973203525633": { name: "Lukas Lutz", dienstnummer: "PD-01", rang: "Chief of Police" },
      "929489098471796756": { name: "Alev Sunal", dienstnummer: "PD-02", rang: "Assistant Chief of Police" },
      "689193377261944853": { name: "Pau Sunal", dienstnummer: "PD-03", rang: "Deputy Chief" },
      "749676361274359869": { name: "Peter Klumb", dienstnummer: "PD-04", rang: "Deputy Chief" },
      "281504730067369985": { name: "Steve McGarret", dienstnummer: "PD-05", rang: "Bureau Chief" },

      "721476043814207830": { name: "Tayo Backa", dienstnummer: "PD-09", rang: "Watch Commander" },
      "663782248998502447": { name: "Walter Waldmeister", dienstnummer: "PD-16", rang: "Inspector" },
      "340137585240440833": { name: "Morata Soler", dienstnummer: "PD-17", rang: "Inspector" },
      "366609124038934528": { name: "Ben Morisson", dienstnummer: "PD-10", rang: "Captain" },
      "708062101457076228": { name: "Vito Ramirez", dienstnummer: "PD-19", rang: "Deputy Inspector" },
      "750431732607483905": { name: "Jule Waldmeister", dienstnummer: "PD-18", rang: "Deputy Inspector" },

      "1142017198718730271": { name: "Blaze Redman", dienstnummer: "PD-22", rang: "Master Lieutenant" },
      "228380461628391424": { name: "Zane Blackwood", dienstnummer: "PD-23", rang: "Master Lieutenant" },
      "378598475971166208": { name: "Toni Deluca", dienstnummer: "PD-26", rang: "Lieutenant III" },
      "1134903991818534942": { name: "Daniel Waldmeister", dienstnummer: "PD-25", rang: "Lieutenant III" },
      "723312724519551006": { name: "Andreas Hackl", dienstnummer: "PD-34", rang: "Lieutenant I" },
      "1217116992616661033": { name: "Panther Nova", dienstnummer: "PD-35", rang: "Lieutenant I" },

      "697119782834536520": { name: "Anton Horvath", dienstnummer: "PD-48", rang: "Staff Sergeant" },
      "247006489632440322": { name: "Felix Miller", dienstnummer: "PD-40", rang: "Specialist" },
      "587348686326202369": { name: "Andreas Graham", dienstnummer: "PD-41", rang: "Staff Sergeant" },
      "1008577835503452211": { name: "Luke Dijk", dienstnummer: "PD-42", rang: "Sergeant I" },
      "498101850856226839": { name: "Reiner Hirsch", dienstnummer: "PD-43", rang: "Staff Sergeant" },
      "543002544348200960": { name: "Jackson Dayne", dienstnummer: "PD-44", rang: "Specialist" },
      "717473357909590099": { name: "Max Koslowski", dienstnummer: "PD-45", rang: "Specialist" },
      "693183499657543780": { name: "Ottmar Zittlau", dienstnummer: "PD-46", rang: "Sergeant III" },
      "513456111160918027": { name: "Ian Miller", dienstnummer: "PD-47", rang: "Sergeant III" },
      "886307752706719825": { name: "Max Lockheed", dienstnummer: "PD-49", rang: "Specialist" },
      "764520163633922060": { name: "Alejandro Rodriguez", dienstnummer: "PD-50", rang: "Specialist" },
      "564390978547351553": { name: "Antonio Moretti", dienstnummer: "PD-51", rang: "Specialist" },
      "550392010612146207": { name: "Keystone Brown", dienstnummer: "PD-53", rang: "Specialist" },
      "711866485651275787": { name: "David Baum", dienstnummer: "PD-54", rang: "Sergeant I" },
      "450016531229966336": { name: "Jason Shaw", dienstnummer: "PD-56", rang: "Sergeant I" },
      "541633624051679262": { name: "Harald Hernandez", dienstnummer: "PD-57", rang: "Staff Sergeant" },
      "1093573634213285989": { name: "Lucius Lich", dienstnummer: "PD-58", rang: "Staff Sergeant" },
      "931064598570893343": { name: "Joey Reed", dienstnummer: "PD-59", rang: "Staff Sergeant" },
      "808712195390701618": { name: "Ali Coban", dienstnummer: "PD-61", rang: "Staff Sergeant" },
      "1261019609818075207": { name: "Elina Thompson", dienstnummer: "PD-62", rang: "Sergeant II" },
      "437314188059344898": { name: "Enrique Vegas", dienstnummer: "PD-63", rang: "Sergeant I" },
      "788866575305408544": { name: "Alvaro Reinh", dienstnummer: "PD-64", rang: "Sergeant III" },
      "878966028347015198": { name: "Peter Maier", dienstnummer: "PD-66", rang: "Specialist" },
      "1283519810570944543": { name: "Sultan Can", dienstnummer: "PD-67", rang: "Staff Sergeant" },
      "811317056245989397": { name: "Dario Ramirez", dienstnummer: "PD-68", rang: "Specialist" },
      "1315048772408971415": { name: "Diego Santos", dienstnummer: "PD-70", rang: "Staff Sergeant" },
      "808103110316785725": { name: "Nosa Holy", dienstnummer: "PD-71", rang: "Sergeant III" },
      "481793329328291840": { name: "Lamar Kasim", dienstnummer: "PD-72", rang: "Sergeant I" },
      "1357827587950252153": { name: "Efe Voga", dienstnummer: "PD-73", rang: "Sergeant I" },
      "579359902800281611": { name: "Beton Tapi", dienstnummer: "PD-74", rang: "Sergeant I" },
      "831635399679017002": { name: "Tom Black", dienstnummer: "PD-77", rang: "Sergeant II" },
      "966081394310783006": { name: "Michael Korczak", dienstnummer: "PD-78", rang: "Specialist" },
      "1215412476359737366": { name: "Lukas Rothe", dienstnummer: "PD-52", rang: "Specialist" },
      "677541121383202817": { name: "Ben Stein", dienstnummer: "PD-55", rang: "Specialist" },

      "877241505016844328": { name: "Salva Sol", dienstnummer: "PA-52", rang: "Anw√§rter" },
      "624039199028543499": { name: "Ludovico Greco", dienstnummer: "PA-56", rang: "Anw√§rter" },
      "935269358098321418": { name: "Nico Bublich", dienstnummer: "PA-57", rang: "Anw√§rter" },
      "1069361772324200478": { name: "Roman Schlag", dienstnummer: "PA-62", rang: "Anw√§rter" },
      "161210739174932481": { name: "Eduardo Sanchez", dienstnummer: "PA-66", rang: "Anw√§rter" },
      "730909080649990204": { name: "Max Aklubat", dienstnummer: "PA-69", rang: "Anw√§rter" },
      "966711299419537468": { name: "Lukas Denzel", dienstnummer: "PA-71", rang: "Anw√§rter" },
      "925887471198306374": { name: "Noah Schlotter", dienstnummer: "PA-73", rang: "Anw√§rter" },
      "526132485101191203": { name: "Max Brechtelsbauer", dienstnummer: "PA-76", rang: "Anw√§rter" },
      "508377615241969674": { name: "Abusa Hanco", dienstnummer: "PA-78", rang: "Anw√§rter" },
      "530031383007985665": { name: "Michael Johnson", dienstnummer: "PA-79", rang: "Anw√§rter" }
    };

    function loadOfficerMap() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return JSON.parse(JSON.stringify(defaultOfficerMap));
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== "object") return JSON.parse(JSON.stringify(defaultOfficerMap));
        return parsed;
      } catch (e) {
        return JSON.parse(JSON.stringify(defaultOfficerMap));
      }
    }
    const officerMap = loadOfficerMap();

    function setLoginStatus(mainText, subText, isGood = false) {
      const mainEl = document.getElementById("login-main");
      const subEl = document.getElementById("login-sub");
      const infoEl = document.getElementById("login-officer-info");
      if (!mainEl || !subEl) return;

      mainEl.textContent = mainText || "";
      subEl.textContent = subText || "";
      if (infoEl) infoEl.textContent = "";

      mainEl.style.color = isGood ? "#a5ffb5" : "#ffffff";
    }

    function getTeamCircle(dienstnummer) {
      if (!dienstnummer) return "‚ö™";
      if (dienstnummer.startsWith("PA-")) return "üü¢";
      if (!dienstnummer.startsWith("PD-")) return "‚ö™";

      const num = parseInt(dienstnummer.split("-")[1], 10);
      if (Number.isNaN(num)) return "‚ö™";

      if (num >= 1 && num <= 5) return "üî¥";
      if (num >= 7 && num <= 19) return "üîµ";
      if (num >= 20 && num <= 39) return "üü°";
      return "‚ö™";
    }

    function getDiscordAccessToken() {
      const hash = window.location.hash.substring(1);
      if (!hash) return null;

      const params = new URLSearchParams(hash);
      const token = params.get("access_token");

      if (token) {
        history.replaceState(null, "", window.location.pathname + window.location.search);
      }
      return token;
    }

    function fillOfficerFromDiscord(discordId, userObj) {
      currentDiscordId = discordId || null;

      const o = officerMap[discordId];
      const mainEl = document.getElementById("login-main");
      const subEl = document.getElementById("login-sub");
      const infoEl = document.getElementById("login-officer-info");

      if (!o) {
        const uname = userObj
          ? userObj.username + (userObj.discriminator ? "#" + userObj.discriminator : "")
          : "Unbekannt";
        setLoginStatus("Eingeloggt (unbekannter Officer)", uname, false);
        if (infoEl) infoEl.textContent = "";
        initVerzeichnis();
        return;
      }

      const full = `${o.name} | ${o.dienstnummer} | ${o.rang}`;
      const [vorname, nachname] = o.name.split(" ");
      const kuerzel = `${vorname.charAt(0)}. ${nachname}`;
      const unterschrift = `${kuerzel}\n${o.name} | ${o.dienstnummer} | ${o.rang}`;

      ["st-officer","ko-officer","fa-officer"].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = full;
      });

      ["st-gezeichnet","ko-gezeichnet","fa-gezeichnet"].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = unterschrift;
      });

      const circle = getTeamCircle(o.dienstnummer);

      if (mainEl && subEl) {
        mainEl.textContent = "Eingeloggt als:";
        mainEl.style.color = "#a5ffb5";
        subEl.textContent = `Team ${circle} [${o.dienstnummer}] ${o.name}`;
      }
      if (infoEl) infoEl.textContent = o.rang;

      initVerzeichnis();
    }

    async function initDiscordUser() {
      const token = getDiscordAccessToken();
      if (!token) {
        setLoginStatus("Nicht mit Discord verbunden", "Bitte √ºber das Portal einloggen.");
        initVerzeichnis();
        return;
      }

      try {
        setLoginStatus("Verbinde mit Discord ‚Ä¶", "Bitte einen Moment warten.");

        const res = await fetch("https://discord.com/api/users/@me", {
          headers: { Authorization: `Bearer ${token}` }
        });

        if (!res.ok) {
          console.error("Discord API Fehler", res.status);
          setLoginStatus("Discord-Fehler", "Benutzerdaten konnten nicht geladen werden.");
          initVerzeichnis();
          return;
        }

        const user = await res.json();
        fillOfficerFromDiscord(user.id, user);
      } catch (err) {
        console.error("Discord Request fehlgeschlagen:", err);
        setLoginStatus("Verbindungsfehler", "Discord konnte nicht erreicht werden.");
        initVerzeichnis();
      }
    }

    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        const tab = btn.dataset.tab;

        document.querySelectorAll("#tab-strafakte, #tab-kollektivakte, #tab-fahndung, #tab-verzeichnis")
          .forEach(el => el.classList.add("hidden"));

        const activeTab = document.getElementById("tab-" + tab);
        if (activeTab) activeTab.classList.remove("hidden");

        const hint = document.getElementById("kollektiv-hinweis");
        if (hint) hint.style.display = (tab === "kollektivakte") ? "block" : "none";

        clearErrors(document);
      });
    });

    function getIdentitaet(prefix) {
      const parts = [];
      if (document.getElementById(prefix + "-id-pers")?.checked)   parts.push("Personalausweis");
      if (document.getElementById(prefix + "-id-waffe")?.checked)  parts.push("Waffenschein");
      if (document.getElementById(prefix + "-id-fs")?.checked)     parts.push("F√ºhrerschein");
      if (document.getElementById(prefix + "-id-finger")?.checked) parts.push("Fingerabdruckscanner");
      if (!parts.length) return "Keine Identit√§tsfeststellung vermerkt.";
      return "Die Identit√§t wurde mittels " + parts.join(", ") + " festgestellt.";
    }

    function addRequiredMarkerFor(forId) {
      const lbl = document.querySelector(`label[for="${forId}"]`);
      if (lbl) lbl.classList.add("label-required");
    }
    function addRequiredMarkerById(labelId) {
      const lbl = document.getElementById(labelId);
      if (lbl) lbl.classList.add("label-required");
    }
    function setBanner(show) {
      const b = document.getElementById("validation-banner");
      if (!b) return;
      b.classList.toggle("show", !!show);
    }
    function markError(el, isError) {
      if (!el) return;
      el.classList.toggle("field-error", !!isError);
    }
    function markGroupError(groupEl, hintEl, isError) {
      if (groupEl) groupEl.classList.toggle("group-error", !!isError);
      if (hintEl) hintEl.classList.toggle("show", !!isError);
    }
    function scrollToFirstError(root) {
      const first = (root || document).querySelector(".field-error, .group-error");
      if (first) {
        first.scrollIntoView({ behavior: "smooth", block: "center" });
        const focusEl = first.matches("input, textarea, select")
          ? first
          : first.querySelector("input, textarea, select");
        if (focusEl) focusEl.focus({ preventScroll: true });
      }
    }
    function clearErrors(root) {
      (root || document).querySelectorAll(".field-error").forEach(el => el.classList.remove("field-error"));
      (root || document).querySelectorAll(".group-error").forEach(el => el.classList.remove("group-error"));
      (root || document).querySelectorAll(".error-hint.show").forEach(el => el.classList.remove("show"));
      setBanner(false);
    }
    function attachAutoClear(ids) {
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        const evt = (el.tagName === "SELECT") ? "change" : "input";
        el.addEventListener(evt, () => {
          if (el.tagName === "SELECT") {
            if (el.value) markError(el, false);
          } else {
            if ((el.value || "").trim()) markError(el, false);
          }
        });
      });
    }
    function validateRequiredFields(spec) {
      let ok = true;

      spec.fields.forEach(f => {
        const el = document.getElementById(f.id);
        if (!el) return;
        const val = (el.value || "").trim();
        const valid = f.type === "select" ? !!el.value : !!val;
        markError(el, !valid);
        if (!valid) ok = false;
      });

      if (spec.ident) {
        const { prefix, groupEl, hintEl } = spec.ident;
        const ids = [prefix + "-id-pers", prefix + "-id-waffe", prefix + "-id-fs", prefix + "-id-finger"];
        const any = ids.some(x => document.getElementById(x)?.checked);
        markGroupError(groupEl, hintEl, !any);
        if (!any) ok = false;

        ids.forEach(cid => {
          const cb = document.getElementById(cid);
          if (!cb) return;
          cb.addEventListener("change", () => {
            const nowAny = ids.some(x => document.getElementById(x)?.checked);
            markGroupError(groupEl, hintEl, !nowAny);
          }, { once: false });
        });
      }

      setBanner(!ok);
      if (!ok) scrollToFirstError(spec.rootEl);
      return ok;
    }

    function initRequiredStarsAndAutoclear() {
      // Pflichtfelder Strafakte
      addRequiredMarkerById("st-id-label");
      addRequiredMarkerFor("st-verlesen");
      addRequiredMarkerFor("st-beisein");
      addRequiredMarkerFor("st-rechtsbeistand");
      addRequiredMarkerFor("st-medizin");

      // Pflichtfelder Kollektivakte
      addRequiredMarkerById("ko-id-label");
      addRequiredMarkerFor("ko-verlesen");
      addRequiredMarkerFor("ko-beisein");
      addRequiredMarkerFor("ko-rechtsbeistand");
      addRequiredMarkerFor("ko-medizin");
      addRequiredMarkerFor("ko-eilverfahren");
      addRequiredMarkerFor("ko-bussgeld");
      addRequiredMarkerFor("ko-bestaetigt-von");
      addRequiredMarkerFor("ko-bestaetigt-zeit");

      attachAutoClear([
        "st-verlesen","st-beisein",
        "ko-verlesen","ko-beisein","ko-eilverfahren","ko-bussgeld","ko-bestaetigt-von","ko-bestaetigt-zeit"
      ]);
    }

    const verzContainerIds = {
      straf: "verzeichnis-straf",
      kollektiv: "verzeichnis-kollektiv",
      fahndung: "verzeichnis-fahndung"
    };

    function getStorageKey(type) {
      const id = currentDiscordId || "unknown";
      return "akten_" + id + "_" + type;
    }

    function saveAkte(type, title, text) {
      try {
        const key = getStorageKey(type);
        const list = JSON.parse(localStorage.getItem(key) || "[]");
        const entry = {
          id: Date.now(),
          title: title || "Ohne Titel",
          createdAt: new Date().toLocaleString("de-DE"),
          text
        };
        list.unshift(entry);
        localStorage.setItem(key, JSON.stringify(list));
        renderVerzeichnisListe(type);
      } catch (e) {
        console.error("Speichern der Akte fehlgeschlagen:", e);
      }
    }

    function renderVerzeichnisListe(type) {
      const containerId = verzContainerIds[type];
      const container = document.getElementById(containerId);
      if (!container) return;

      const key = getStorageKey(type);
      const list = JSON.parse(localStorage.getItem(key) || "[]");

      container.innerHTML = "";

      if (!list.length) {
        const empty = document.createElement("div");
        empty.className = "verz-empty";
        empty.textContent = "Noch keine Akten gespeichert.";
        container.appendChild(empty);
        return;
      }

      list.forEach(entry => {
        const div = document.createElement("div");
        div.className = "verz-item";

        const spanTitle = document.createElement("span");
        spanTitle.className = "verz-item-title";
        spanTitle.textContent = entry.title;

        const spanDate = document.createElement("span");
        spanDate.className = "verz-item-date";
        spanDate.textContent = entry.createdAt;

        div.appendChild(spanTitle);
        div.appendChild(spanDate);

        div.addEventListener("click", () => {
          const out = document.getElementById("output");
          if (out) out.value = entry.text;
        });

        container.appendChild(div);
      });
    }

    function initVerzeichnis() {
      ["straf","kollektiv","fahndung"].forEach(renderVerzeichnisListe);
    }

    // Helper: garantiert genau 1 Leerzeile zwischen Bl√∂cken
    function addBlock(out, title, content) {
      out += title + "\n";
      if (content && content.trim()) out += content.trim() + "\n";
      return out + "\n";
    }

    function genStrafakte() {
      const root = document.getElementById("tab-strafakte");
      clearErrors(root);

      const ok = validateRequiredFields({
        rootEl: root,
        fields: [
          { id: "st-verlesen", type: "text" },
          { id: "st-beisein", type: "text" },
          { id: "st-rechtsbeistand", type: "select" },
          { id: "st-medizin", type: "select" }
        ],
        ident: {
          prefix: "st",
          groupEl: document.getElementById("st-id-group"),
          hintEl: document.getElementById("st-id-hint")
        }
      });
      if (!ok) return;

      const officer = document.getElementById("st-officer").value.trim();
      const tatort = document.getElementById("st-tatort").value.trim();
      const besch = document.getElementById("st-beschuldigte").value.trim();
      const ges = document.getElementById("st-geschaedigte").value.trim();
      const sach = document.getElementById("st-sachverhalt").value.trim();
      const includeSach = document.getElementById("st-sachverhalt-include")?.checked;
      const idTxt = getIdentitaet("st");
      const zeugen = document.getElementById("st-zeugen").value.trim();
      const geg = document.getElementById("st-gegenstaende").value.trim();
      const verlesen = document.getElementById("st-verlesen").value.trim();
      const beisein = document.getElementById("st-beisein").value.trim();
      const rb = document.getElementById("st-rechtsbeistand").value;
      const med = document.getElementById("st-medizin").value;
      const gezeichnet = document.getElementById("st-gezeichnet").value.trim();

      let out = "";
      out += "| - Strafakte - |\n\n";
      out += "Narco City Police Department\n";
      out += (officer || "‚Äî") + "\n\n";

      out = addBlock(out, "| Tatort und Zeitraum: |", tatort || "‚Äî");

      out = addBlock(out, "| Beschuldigte Person(en): |", besch || "‚Äî");
      out += (idTxt || "‚Äî") + "\n\n";

      out = addBlock(out, "| Gesch√§digte Person(en): |", ges || "‚Äî");

      out += "|Sachverhalt aus Sicht der Beh√∂rde: |\n";
      if (includeSach && sach) out += sach + "\n";
      out += "\n";

      out = addBlock(out, "| Weitere beteiligte Einheiten/Zeugen: |", zeugen || "‚Äî");

      out = addBlock(out, "| Abgenommene Gegenst√§nde: |", geg || "‚Äî");

      out += "| Bemerkungen: |\n";
      out += "Die Rechte wurden dem Beschuldigten durch " + verlesen + " im Beisein von " + beisein + " verlesen und verstanden.\n";

      if (rb === "bestand") out += "Dieser bestand auf einen Rechtsbeistand.\n";
      if (rb === "verzichtete") out += "Dieser verzichtete auf einen Rechtsbeistand.\n";

      if (med === "bestand") out += "Der TV bestand auf medizinische Versorgung.\n";
      if (med === "verzichtete") out += "Der TV verzichtete auf medizinische Versorgung.\n";

      out += "Das Bu√ügeld ist in 7 Tagen zu bezahlen.\n";
      out += "Die dem Tatverd√§chtigen abgenommenen Gegenst√§nde wurden in seinen pers√∂nlichen Spind gelegt.\n\n";

      out += "| Gezeichnet von: |\n";
      out += (gezeichnet || "‚Äî") + "\n";

      document.getElementById("output").value = out;
      const titel = tatort || (besch.split("\n")[0] || "Strafakte ohne Titel");
      saveAkte("straf", titel, out);
    }

    function genKollektivakte() {
      const root = document.getElementById("tab-kollektivakte");
      clearErrors(root);

      const ok = validateRequiredFields({
        rootEl: root,
        fields: [
          { id: "ko-verlesen", type: "text" },
          { id: "ko-beisein", type: "text" },
          { id: "ko-rechtsbeistand", type: "select" },
          { id: "ko-medizin", type: "select" },
          { id: "ko-eilverfahren", type: "text" },
          { id: "ko-bussgeld", type: "text" },
          { id: "ko-bestaetigt-von", type: "text" },
          { id: "ko-bestaetigt-zeit", type: "text" }
        ],
        ident: {
          prefix: "ko",
          groupEl: document.getElementById("ko-id-group"),
          hintEl: document.getElementById("ko-id-hint")
        }
      });
      if (!ok) return;

      const officer = document.getElementById("ko-officer").value.trim();
      const tatort = document.getElementById("ko-tatort").value.trim();
      const besch = document.getElementById("ko-beschuldigte").value.trim();
      const ges = document.getElementById("ko-geschaedigte").value.trim();
      const sach = document.getElementById("ko-sachverhalt").value.trim();
      const idTxt = getIdentitaet("ko");
      const zeugen = document.getElementById("ko-zeugen").value.trim();
      const geg = document.getElementById("ko-gegenstaende").value.trim();
      const verlesen = document.getElementById("ko-verlesen").value.trim();
      const beisein = document.getElementById("ko-beisein").value.trim();
      const rb = document.getElementById("ko-rechtsbeistand").value;
      const med = document.getElementById("ko-medizin").value;
      const eil = document.getElementById("ko-eilverfahren").value.trim();
      const buss = document.getElementById("ko-bussgeld").value.trim();
      const bestaetigtVon = document.getElementById("ko-bestaetigt-von").value.trim();
      const bestaetigtZeit = document.getElementById("ko-bestaetigt-zeit").value.trim();
      const gezeichnet = document.getElementById("ko-gezeichnet").value.trim();

      let out = "";
      out += "| - Kollektivakte - |\n";
      out += "Narco City Police Department\n";
      out += (officer || "‚Äî") + "\n\n";
      out += "Kollektivakte wurde von " + bestaetigtVon + " um " + bestaetigtZeit + " genehmigt\n\n";

      out = addBlock(out, "| Tatort und Zeitraum: |", tatort || "‚Äî");
      out = addBlock(out, "| Beschuldigte Personen: |", besch || "‚Äî");
      out = addBlock(out, "| Gesch√§digte Person(en): |", ges || "‚Äî");
      out = addBlock(out, "| Sachverhalt aus Sicht des NCPDs: |", sach || "‚Äî");

      out += (idTxt || "‚Äî") + "\n\n";

      out = addBlock(out, "| Weitere beteiligte Einheiten/Zeugen: |", zeugen || "‚Äî");
      out = addBlock(out, "| Abgenommene Gegenst√§nde: |", geg || "‚Äî");

      out += "| Bemerkungen: |\n";
      out += "Die Rechte wurden dem Beschuldigten durch " + verlesen + " im Beisein von " + beisein + " verlesen und verstanden.\n";

      if (rb === "bestand") out += "Diese bestand auf einen Rechtsbeistand.\n";
      if (rb === "verzichtete") out += "Diese verzichtete auf einen Rechtsbeistand.\n";

      if (med === "bestand") out += "Die TV¬¥s bestanden auf medizinische Versorgung.\n";
      if (med === "verzichtete") out += "Die TV¬¥s verzichteten auf medizinische Versorgung.\n";

      out += "Das Eilverfahren wurde durch " + eil + " abgelehnt.\n";
      out += "Das Bu√ügeld ist bis zum " + buss + " zu bezahlen.\n\n";

      out += "| Gezeichnet von: |\n";
      out += (gezeichnet || "‚Äî") + "\n";

      document.getElementById("output").value = out;
      const titel = tatort || "Kollektivakte ohne Titel";
      saveAkte("kollektiv", titel, out);
    }

    function genFahndung() {
      const officer    = document.getElementById("fa-officer")?.value?.trim() || "";
      const datum      = document.getElementById("fa-datum")?.value?.trim() || "";
      const tatort     = document.getElementById("fa-tatort")?.value?.trim() || "";
      const person     = document.getElementById("fa-person")?.value?.trim() || "";
      const paragrafen = document.getElementById("fa-paragrafen")?.value?.trim() || "";
      const sach       = document.getElementById("fa-sachverhalt")?.value?.trim() || "";
      const hinweise   = document.getElementById("fa-hinweise")?.value?.trim() || "";
      const einheiten  = document.getElementById("fa-einheiten")?.value?.trim() || "";
      const gezeichnet = document.getElementById("fa-gezeichnet")?.value?.trim() || "";

      let out = "";
      out += "| - Ergreifungsakte - |\n\n";
      out += "Narco City Police Department\n";
      out += (officer || "‚Äî") + "\n\n";

      out += "| Tatort und Zeitraum: |\n";
      out += (tatort || "‚Äî") + "\n";
      out += "Am " + (datum || "‚Äî") + "\n\n";

      out = addBlock(out, "| Beschuldigte Person(en): |", person || "‚Äî");
      out += "| Gesch√§digte Person(en): |\n";
      out += "‚Äî-----------------------\n\n";

      out += "| Sachverhalt aus Sicht des NCPDs: |\n";
      if (paragrafen) out += paragrafen + "\n";
      out += "\n";

      out = addBlock(out, "|Sachverhalt:|", sach || "‚Äî");
      out = addBlock(out, "| Weitere beteiligte Einheiten/Zeugen: |", einheiten || "‚Äî");
      out = addBlock(out, "| Besondere Hinweise: |", hinweise || "‚Äî");

      out += "| Bemerkungen: |\n";
      out += "Die o.g. Beschuldigte ist fl√ºchtig. Beim Antreffen der Beschuldigten ist diese festzunehmen, ihre Rechte zu belehren und der gerechten Strafe zuzuf√ºhren.\n\n";

      out += "| Gezeichnet von: |\n";
      out += (gezeichnet || "‚Äî") + "\n";

      document.getElementById("output").value = out;
      const titel = person.split("\n")[0] || "Ergreifungsakte ohne Titel";
      saveAkte("fahndung", titel, out);
    }

    function resetForm() {
      const keepIds = new Set([
        "st-officer","ko-officer","fa-officer",
        "st-gezeichnet","ko-gezeichnet","fa-gezeichnet"
      ]);

      document.querySelectorAll("input, textarea, select").forEach(el => {
        if (!el.id) return;
        if (keepIds.has(el.id)) return;

        if (el.type === "checkbox") el.checked = false;
        else if (el.tagName === "SELECT") el.value = "";
        else el.value = "";
      });

      clearErrors(document);
      const out = document.getElementById("output");
      if (out) out.value = "";
    }

    document.getElementById("btn-strafakte").addEventListener("click", genStrafakte);
    document.getElementById("btn-kollektivakte").addEventListener("click", genKollektivakte);
    document.getElementById("btn-fahndung").addEventListener("click", genFahndung);

    document.getElementById("btn-copy").addEventListener("click", async () => {
      const out = document.getElementById("output");
      const text = out?.value || "";
      if (!text) return;
      try {
        await navigator.clipboard.writeText(text);
      } catch (e) {
        out.select();
        out.setSelectionRange(0, 99999);
        try { document.execCommand("copy"); } catch (err) {}
      }
    });

    document.getElementById("btn-reset").addEventListener("click", resetForm);

    initDiscordUser();
    initRequiredStarsAndAutoclear();

    const hintInit = document.getElementById("kollektiv-hinweis");
    if (hintInit) hintInit.style.display = "none";
  </script>
</body>
</html>
